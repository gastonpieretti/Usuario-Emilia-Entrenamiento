generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int              @id @default(autoincrement())
  email                  String           @unique
  name                   String?
  lastName               String?
  passwordHash           String
  role                   Role             @default(client)
  height                 Float?
  weight                 Float?
  age                    Int?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  hasCompletedOnboarding Boolean          @default(false)
  isApproved             Boolean          @default(false)
  securityAnswer         String?
  securityQuestion       String?
  isDeleted              Boolean          @default(false)
  planExpiresAt          DateTime?
  planStartDate          DateTime?
  acquiredMonths         Int              @default(1)
  planSchedule           Json?
  diets                  Diet[]
  receivedMessages       Message[]        @relation("ReceivedMessages")
  sentMessages           Message[]        @relation("SentMessages")
  progress               Progress[]
  routines               Routine[]
  routineHistory         RoutineHistory[]
  profile                UserProfile?
}

model Message {
  id         Int      @id @default(autoincrement())
  content    String
  senderId   Int
  receiverId Int
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
}

model UserProfile {
  id                 Int      @id @default(autoincrement())
  userId             Int      @unique
  city               String?
  country            String?
  whatsapp           String?
  occupation         String?
  measurements       String?
  injuries           String?
  energyLevel        String?
  goal               String?
  experienceLevel    String?
  trainingLocation   String?
  equipment          String[]
  daysPerWeek        Int?
  mealsPerDay        Int?
  dislikedFood       String?
  dietPreference     String?
  waterIntake        String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  age                Int?
  gender             String?
  painColumna        Boolean  @default(false)
  painHombro         Boolean  @default(false)
  painRodilla        Boolean  @default(false)
  height_cm          Float?
  sessionDurationMin Int?
  weight_kg          Float?
  targetWeight       Float?
  aptoSobrepeso      Boolean  @default(false)
  user               User     @relation(fields: [userId], references: [id])
}

model Routine {
  id          Int               @id @default(autoincrement())
  userId      Int
  title       String
  description String?
  weekDay     String
  createdAt   DateTime          @default(now())
  order       Int               @default(0)
  isApproved     Boolean           @default(false)
  blueprint      Json?
  month          Int               @default(1)
  activationDate DateTime?
  user           User              @relation(fields: [userId], references: [id])
  exercises   RoutineExercise[]
  history     RoutineHistory[]
}

model Exercise {
  id                      Int                @id @default(autoincrement())
  categoria               String
  idVariante              Int?
  instruccionesTecnicas   String
  nivel                   String
  nombre                  String
  repsSugeridas           String
  seriesSugeridas         Int
  urlVideoLoop            String
  equipamiento            String[]
  impacto                 String?
  lugar                   String[]
  nivel_permitido         String[]
  riesgo_columna          String?
  riesgo_hombro           String?
  riesgo_rodilla          String?
  fatiga_neuromuscular    Int?
  frecuencia_max_semanal  Int?
  grupo_muscular_primario String?
  patron_movimiento       String?
  orden_recomendado       String?
  routineExercises        RoutineExercise[]
  templateExercises       TemplateExercise[]
}

model RoutineExercise {
  id         Int      @id @default(autoincrement())
  routineId  Int
  exerciseId Int
  sets       Int
  reps       String
  restTime   String
  order      Int      @default(0)
  isSuperset Boolean  @default(false)
  exercise   Exercise @relation(fields: [exerciseId], references: [id])
  routine    Routine  @relation(fields: [routineId], references: [id])
}

model Diet {
  id             Int      @id @default(autoincrement())
  userId         Int
  title          String
  description    String?
  createdAt      DateTime @default(now())
  carbG          Int?
  fatG           Int?
  mealsStructure String?
  proteinG       Int?
  targetCalories Int?
  user           User     @relation(fields: [userId], references: [id])
}

model Progress {
  id     Int      @id @default(autoincrement())
  userId Int
  weight Float
  waist  Float?
  legs   Float?
  hips   Float?
  date   DateTime @default(now())
  user   User     @relation(fields: [userId], references: [id])
}

model RoutineTemplate {
  id          Int                @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  exercises   TemplateExercise[]
}

model TemplateExercise {
  id                Int             @id @default(autoincrement())
  routineTemplateId Int
  exerciseId        Int
  sets              Int
  reps              String
  restTime          String
  order             Int             @default(0)
  exercise          Exercise        @relation(fields: [exerciseId], references: [id])
  template          RoutineTemplate @relation(fields: [routineTemplateId], references: [id])
}

model RoutineHistory {
  id         Int      @id @default(autoincrement())
  routineId  Int
  userId     Int
  data       Json
  changeType String
  createdAt  DateTime @default(now())
  routine    Routine  @relation(fields: [routineId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])
}

enum Role {
  client
  admin
}
